-- ESQUEMA DE BASE DE DATOS PARA DIRECTORIO PROFESIONAL (SUPABASE)
-- Generado por: Jules, Product Architect

-- 1. TIPOS PERSONALIZADOS
CREATE TYPE user_role AS ENUM ('admin', 'business_owner', 'customer');

-- 2. TABLA DE PERFILES (Extensión de auth.users)
CREATE TABLE profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
  full_name TEXT,
  avatar_url TEXT,
  role user_role DEFAULT 'customer',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 3. CATEGORÍAS Y SUBCATEGORÍAS
CREATE TABLE categories (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  icon_name TEXT, -- Referencia a Lucide o FontAwesome
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

CREATE TABLE subcategories (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  category_id BIGINT REFERENCES categories ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 4. NEGOCIOS
CREATE TABLE businesses (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  owner_id UUID REFERENCES profiles(id) ON DELETE SET NULL,
  category_id BIGINT REFERENCES categories ON DELETE SET NULL,
  subcategory_id BIGINT REFERENCES subcategories ON DELETE SET NULL,
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  description TEXT,
  address TEXT,
  city TEXT,
  state TEXT,
  country TEXT,
  latitude DOUBLE PRECISION,
  longitude DOUBLE PRECISION,
  phone TEXT,
  whatsapp TEXT,
  website TEXT,
  email TEXT,
  is_verified BOOLEAN DEFAULT FALSE,
  is_premium BOOLEAN DEFAULT FALSE,
  rating_avg NUMERIC(3, 2) DEFAULT 0,
  review_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 5. HORARIOS DE ATENCIÓN
CREATE TABLE business_hours (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  business_id UUID REFERENCES businesses ON DELETE CASCADE NOT NULL,
  day_of_week SMALLINT NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6), -- 0=Domingo
  open_time TIME,
  close_time TIME,
  is_closed BOOLEAN DEFAULT FALSE
);

-- 6. GALERÍA DE FOTOS
CREATE TABLE business_photos (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  business_id UUID REFERENCES businesses ON DELETE CASCADE NOT NULL,
  url TEXT NOT NULL,
  is_main BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 7. RESEÑAS Y CALIFICACIONES
CREATE TABLE reviews (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  business_id UUID REFERENCES businesses ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
  rating SMALLINT NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 8. FAVORITOS
CREATE TABLE favorites (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
  business_id UUID REFERENCES businesses ON DELETE CASCADE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
  UNIQUE(user_id, business_id)
);

-- 9. SEGURIDAD (RLS)
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE subcategories ENABLE ROW LEVEL SECURITY;
ALTER TABLE businesses ENABLE ROW LEVEL SECURITY;
ALTER TABLE business_hours ENABLE ROW LEVEL SECURITY;
ALTER TABLE business_photos ENABLE ROW LEVEL SECURITY;
ALTER TABLE reviews ENABLE ROW LEVEL SECURITY;
ALTER TABLE favorites ENABLE ROW LEVEL SECURITY;

-- 10. POLÍTICAS DE ACCESO
-- Perfiles
CREATE POLICY "Perfiles públicos son visibles por todos." ON profiles FOR SELECT USING (true);
CREATE POLICY "Usuarios pueden insertar su propio perfil." ON profiles FOR INSERT WITH CHECK (auth.uid() = id);
CREATE POLICY "Usuarios pueden actualizar su propio perfil." ON profiles FOR UPDATE USING (auth.uid() = id);

-- Categorías (Lectura pública)
CREATE POLICY "Categorías visibles por todos." ON categories FOR SELECT USING (true);
CREATE POLICY "Subcategorías visibles por todos." ON subcategories FOR SELECT USING (true);

-- Negocios
CREATE POLICY "Negocios visibles por todos." ON businesses FOR SELECT USING (true);
CREATE POLICY "Dueños pueden gestionar sus negocios." ON businesses FOR ALL USING (auth.uid() = owner_id);

-- Reseñas
CREATE POLICY "Reseñas visibles por todos." ON reviews FOR SELECT USING (true);
CREATE POLICY "Usuarios autenticados pueden reseñar." ON reviews FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Favoritos
CREATE POLICY "Usuarios ven sus propios favoritos." ON favorites FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Usuarios gestionan sus propios favoritos." ON favorites FOR ALL USING (auth.uid() = user_id);

-- 11. FUNCIONES Y TRIGGERS (Auto-actualización de updated_at)
CREATE OR REPLACE FUNCTION handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER on_profiles_updated BEFORE UPDATE ON profiles FOR EACH ROW EXECUTE PROCEDURE handle_updated_at();
CREATE TRIGGER on_businesses_updated BEFORE UPDATE ON businesses FOR EACH ROW EXECUTE PROCEDURE handle_updated_at();

-- 12. DATOS SEMILLA (Ejemplos)
INSERT INTO categories (name, slug, icon_name) VALUES
('Restaurantes', 'restaurantes', 'utensils'),
('Construcción', 'construccion', 'hard-hat'),
('Plomería', 'plomeria', 'droplet'),
('Electricistas', 'electricistas', 'zap'),
('Jardinería', 'jardineria', 'leaf'),
('Limpieza', 'limpieza', 'sparkles'),
('Mecánicos', 'mecanicos', 'wrench');
